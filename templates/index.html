<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodyMix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    
    <header>
        <h1>MelodyMix</h1>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#playlists">Playlists</a></li>
                <li><a href="#mood">Mood</a></li>
                <li><a href="#saved">Saved</a></li>
                <li><a href="#search-songs">Search</a></li>
                <li><a href="#playlist-analytics">Analytics</a></li>
                <li><a href="#share-playlist">Share</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="available-songs">
            <h2>Available Songs</h2>
            <ul id="song-list">
                <li draggable="true" data-src="/static/audio/03. Millionaire - O2SRK Mashup.mp3">Millionaire</li>
                <li draggable="true" data-src="/static/audio/21_Savage_Metro_Boomin_-_Glock_in_My_Lap_Offblogmedia.com.mp3">21 Savage - Glock in My Lap</li>
                <li draggable="true" data-src="/static/audio/Kendrick_Lamar_Ft_Zacari_-_LOVE_Offblogmedia.com.mp3">Kendrick Lamar - LOVE</li>
            </ul>
        </section>

        <section id="now-playing">
            <h2>Now Playing</h2>
            <p id="current-song">No song playing</p>
            <audio id="audio-player" controls></audio>
        </section>

        <section id="playlists">
            <h2>Playlists</h2>
            <ul id="playlist-list">
                <li data-src="/static/audio/03. Millionaire - O2SRK Mashup.mp3">Millionaire</li>
                <li data-src="/static/audio/21_Savage_Metro_Boomin_-_Glock_in_My_Lap_Offblogmedia.com.mp3">21 Savage - Glock in My Lap</li>
                <li data-src="/static/audio/Kendrick_Lamar_Ft_Zacari_-_LOVE_Offblogmedia.com.mp3">Kendrick Lamar - LOVE</li>
            </ul>
        </section>

        <section id="search-songs">
            <h2>Search Songs</h2>
            <input type="text" id="search-query" placeholder="Search for songs...">
            <button onclick="searchSongs()">Search</button>
            <div id="search-results"></div>
        </section>

        <section id="create-playlist">
            <h2>Create Playlist</h2>
            <input type="text" id="playlist-name" placeholder="Playlist Name">
            <button onclick="createPlaylist()">Create</button>
            <ul id="playlist-songs"></ul>
        </section>

        <section id="collaborate">
            <h2>Collaborate on Playlists</h2>
            <input type="text" id="collaborator-name" placeholder="Contributor Name">
            <button onclick="collaborate()">Add Contributor</button>
        </section>
    </main>

    <!-- Footer Section -->
    <footer>
        <p>&copy; 2025 MelodyMix. Built with ❤️ by <a href="#">Benedwe</a>.</p>
    </footer>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function allowDrop(event) {
            event.preventDefault();
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.innerText);
        }

        function drop(event) {
            event.preventDefault();
            const song = event.dataTransfer.getData("text");
            const li = document.createElement("li");
            li.innerText = song;
            document.getElementById("playlist-songs").appendChild(li);
        }

        function sharePlaylist() {
            const playlistName = document.getElementById("share-playlist-name").value;
            const shareType = document.getElementById("share-type").value;

            fetch("/share_playlist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user: "Benedwe", // Replace with actual user
                    playlist_name: playlistName,
                    share_type: shareType
                })
            })
                .then(response => response.json())
                .then(data => {
                    const message = document.getElementById("share-message");
                    if (data.message) {
                        message.textContent = data.message;
                        if (data.link) {
                            message.innerHTML += ` <a href="${data.link}" target="_blank">Open Link</a>`;
                        }
                    } else {
                        message.textContent = data.error;
                    }
                })
                .catch(error => console.error("Error sharing playlist:", error));
        }

        function loadPublicPlaylists() {
            fetch("/public_playlists")
                .then(response => response.json())
                .then(data => {
                    const publicPlaylistList = document.getElementById("public-playlist-list");
                    publicPlaylistList.innerHTML = "";
                    data.public_playlists.forEach(playlist => {
                        const li = document.createElement("li");
                        li.textContent = playlist.name;
                        publicPlaylistList.appendChild(li);
                    });
                })
                .catch(error => console.error("Error loading public playlists:", error));
        }

        // Load public playlists on page load
        document.addEventListener("DOMContentLoaded", loadPublicPlaylists);

        function fetchAnalytics() {
            fetch(`/playlist_analytics?user=example_user`)
                .then(response => response.json())
                .then(data => {
                    const analyticsList = document.getElementById('analytics-results');
                    analyticsList.innerHTML = '';
                    if (data.analytics) {
                        data.analytics.forEach(playlist => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${playlist.playlist_name}</strong>: 
                                            ${playlist.total_songs} songs, ${playlist.total_playtime}`;
                            analyticsList.appendChild(li);
                        });
                    } else {
                        analyticsList.innerHTML = `<li>${data.error}</li>`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function searchSongs() {
            const query = document.getElementById('search-query').value;
            fetch(`/search_songs?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsList = document.getElementById('search-results');
                    resultsList.innerHTML = '';
                    if (data.songs) {
                        data.songs.forEach(song => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${song.title}</strong> by ${song.artist} 
                                            <a href="${song.url}" target="_blank">Listen</a>`;
                            resultsList.appendChild(li);
                        });
                    } else {
                        resultsList.innerHTML = `<li>${data.error}</li>`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function downloadPlaylist(playlistName) {
            fetch(`/download_playlist/${encodeURIComponent(playlistName)}?user=example_user`)
                .then(response => response.json())
                .then(data => alert(data.message || data.error))
                .catch(error => console.error('Error:', error));
        }

        function playSong(event) {
            const audioPlayer = document.getElementById('audio-player');
            const currentSong = document.getElementById('current-song');

            // Get the data-src attribute of the clicked song
            const songSrc = event.target.getAttribute('data-src');
            const songTitle = event.target.textContent;

            if (songSrc) {
                // Update the audio player's source and play the song
                audioPlayer.src = songSrc;
                audioPlayer.play();

                // Update the "Now Playing" text
                currentSong.textContent = `Now Playing: ${songTitle}`;
            } else {
                alert('Audio source not found!');
            }
        }

        // Add event listeners to the song list
        document.querySelectorAll('#song-list ul li').forEach(song => {
            song.addEventListener('click', playSong);
        });

        function collaborate() {
            const playlistName = document.getElementById("playlist-name").value;
            const contributor = document.getElementById("collaborator-name").value;

            fetch("/collaborate_playlist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ playlist_name: playlistName, contributor: contributor })
            })
                .then(response => response.json())
                .then(data => alert(data.message || data.error));
        }
    </script>
</body>
</html>
